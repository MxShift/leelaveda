LeelaGame={turn:1,players:[]},Leela={init:function(){Leela.design.tpls=$("#tpls"),Leela.history.el=$("#actions-steps"),Leela.design.logo=$("#logo"),Leela.map.el=$("#map"),Leela.players.el=$("#players-list"),Leela.map.init(),Leela.actions.init(),Leela.history.init(),Leela.players.init(),Leela.design.init()},design:{min:320,init:function(){Leela.design.nav("#players","#players-btn","#players-panel"),Leela.design.nav("#actions","#actions-btn","#actions-panel"),$("#author-btn").click(function(){$('[data-remodal-id="about-author"]').remodal().open()}),Leela.design.adaptive();var e=window.location.href;if(-1!==e.indexOf("#cell-")){var a=e.split("-");$("#cell-"+a[1]).click()}else LeelaGame.players[0].history.length||1!=LeelaGame.players.length||$('[data-remodal-id="intro"]').remodal().open();$(document).on("closed",".remodal",function(){Leela.design.modal&&Leela.design.modal.destroy(),Leela.actions.panel.is(":hidden")&&Leela.actions.btn.click()})},nav:function(e,a,l){e=$(e),a=$(a),l=$(l),a.click(function(){l.hasClass("clicked")?l.hide().removeClass("clicked"):($(window).width()<1366&&$(".fixed-panel:not(#"+e.attr("id")+"-panel)").hide().removeClass("clicked"),l.show().addClass("clicked"))})},adaptive:function(){$("body").css({"min-width":Leela.design.min}),$(window).resize(function(){var e=$(this),a=e.width(),l=e.height();if(!(a<Leela.design.min||l<Leela.design.min)){var i=Leela.map.width/Leela.map.height,t=Math.min(a,Leela.map.width),n=t/i;Leela.map.el.css({width:t,height:n}),Leela.design.logo.width(a);for(var r=LeelaGame.players.length,o=0;r>o;o++){var s=LeelaGame.players[o],d=s.history,c=d.length?d[d.length-1].cell_id:68,m=$("#cell-"+c).position();$("#map-player-"+s.id).css({top:m.top,left:m.left})}Leela.history.el.css({height:l-430})}}).resize(),Leela.actions.btn.click(),$(window).width()>1366&&$("#players-btn").click(),"ontouchstart"in window&&Leela.map.el.addClass("touch")},tpl:function(e,a){for(var l=Leela.design.tpls.find(e).clone(),i=$("<div />").append(l),t=i.html(),n=a.length,r=0;n>r;r++){var o=new RegExp("{"+a[r].name+"}","gi");t=t.replace(o,a[r].value)}return t}},players:{max:7,init:function(){Leela.players.add_btn=$("#players-add"),Leela.players.add_btn.click(function(){Leela.players.add()}),Leela.players.load(),Leela.players.next(1)},load:function(e){if(!e){var a=localStorage.getItem("LeelaGame");a&&(LeelaGame=JSON.parse(a))}LeelaGame.players.length?Leela.history.fill(e):Leela.players.add()},add:function(e,a,l){if(e||(e={id:LeelaGame.players.length?LeelaGame.players[LeelaGame.players.length-1].id+1:1,name:"",ava:0,history:[],six:0}),a||LeelaGame.players.push(e),!l){var i=[{name:"id",value:e.id},{name:"name",value:e.name},{name:"ava",value:e.ava}],t=$(Leela.design.tpl(".nav-player:first",i)),n=t.find(".nav-name");e.name||(e.name=n.attr("placeholder"),n.val(e.name)),n.blur(function(){var a=n.val();a||(a=n.attr("placeholder"),n.val(a)),$(".player-name-"+e.id).text(a),LeelaGame.players[Leela.players.get(e.id).i].name=a}),t.find(".nav-ava").click(function(){Leela.players.ava(e.id)}),t.find(".nav-hist").click(function(){var e=$(this).parent().attr("data-id"),a=LeelaGame.players[Leela.players.get(e).i],l=[{name:"id",value:"history"},{name:"data",value:Leela.design.tpl(".hist-full:first",[{name:"name",value:a.name}])}];Leela.design.modal=$(Leela.design.tpl(".remodal-tpl:first",l)),Leela.design.modal.find("img:first").attr("src","img/ava/"+a.ava+".png"),Leela.design.modal.removeClass("remodal-tpl").addClass("remodal").appendTo("body"),Leela.design.modal=Leela.design.modal.remodal(),Leela.design.modal.open(),Leela.players.load(e)}),t.on("click",".nav-del",function(){Leela.players.del(e.id)}),Leela.players.el.append(t),e.ava||(i[2].value=Leela.players.ava(e.id));var r=$(Leela.design.tpl(".map-player:first",i));r.click(function(){var a=LeelaGame.players[Leela.players.get(e.id).i].history,l=a.length?a[a.length-1].cell_id:68;$("#cell-"+l).click()}),Leela.map.el.append(r),LeelaGame.players.length==Leela.players.max&&Leela.players.add_btn.hide()}},del:function(e){if(1==LeelaGame.players.length)return void alert($("#alert-del-last").text());var a=Leela.players.get(e),l=$("#alert-del-confirm").text().replace(/{name}/,a.name);window.confirm(l)&&(LeelaGame.turn==e&&Leela.players.next(),LeelaGame.players.splice(a.i,1),$("#nav-player-"+e+", #map-player-"+e).remove(),Leela.players.add_btn.show())},get:function(e){for(var a=LeelaGame.players.length,l=0;a>l;l++)if(e==LeelaGame.players[l].id)return LeelaGame.players[l].i=l,LeelaGame.players[l]},ava:function(e){for(var a=$("#nav-player-"+e+" .nav-ava"),l=$("#map-player-"+e),i=[],t=Leela.players.get(e),n=LeelaGame.players.length,r=0;n>r;r++)e!=LeelaGame.players[r].id&&i.push(LeelaGame.players[r].ava);for(var o=0,r=t.ava+1;r<=Leela.players.max;r++)if(-1==$.inArray(r,i)){o=r;break}if(!o)for(var r=1;r<=Leela.players.max;r++)if(-1==$.inArray(r,i)){o=r;break}return a.add(l).removeClass("ava-"+t.ava).addClass("ava-"+o),t.ava=o,t.ava},next:function(e){if(!e){var a=LeelaGame.players[LeelaGame.players.length-1].id;LeelaGame.turn&&LeelaGame.turn!=a?LeelaGame.turn=LeelaGame.players[Leela.players.get(LeelaGame.turn).i+1].id:LeelaGame.turn=LeelaGame.players[0].id}Leela.players.el.find(".nav-ava.rotating").removeClass("rotating"),Leela.players.el.find("#nav-player-"+LeelaGame.turn+" .nav-ava").addClass("rotating"),Leela.map.el.find(".map-player.rotating").removeClass("rotating"),Leela.map.el.find("#map-player-"+LeelaGame.turn).addClass("rotating"),Leela.actions.nav()},move:function(e,a){function l(){$("#cell-"+a).click();var l=new Date;Leela.history.add({player_id:i.id,dice:e,cell_id:a,date:l.getTime(),six:i.six}),s&&1==s||-1!==$.inArray(Leela.map.cells[a-1].type,["arrow","snake"])||i.six?Leela.actions.nav():Leela.players.next()}$(window).width()<1366&&$(".fixed-panel").hide().removeClass("clicked"),e=1*e,a&&(a=1*a);var i=LeelaGame.players[Leela.players.get(LeelaGame.turn).i],t=i.history;if(!t.length||68==t[t.length-1].cell_id){if(6!=e)return void Leela.players.next();a=1}var n=0;if(6==e&&i.six++,3==i.six&&e&&6>e){alert($("#alert-six-3").text());for(var r=t.length-1,o=r;o>=0;o--)if(t[o].dice&&t[o].dice<6||!o){a=t[o].cell_id+e,n=1;break}}if(i.six>3&&e&&6>e){alert($("#alert-six-4").text());for(var r=t.length-1,o=r;o>=0;o--)if(t[o].dice&&t[o].dice<6||!o){a=t[o].cell_id+6*i.six+e,n=1;break}}e&&6>e&&(i.six=0);var s=t.length?t[t.length-1].cell_id:68;if(i.six>3)return void Leela.actions.nav();if(a>72&&(a=t[t.length-1].cell_id),!a&&(a=s+e,a>72))return 6>e?void Leela.players.next():void Leela.actions.nav();if(68==a||s+e==68){var d=$('<img src="img/salute.gif" id="salute">');d.add(Leela.actions.dice.el).one("click",function(){d.fadeOut("fast",function(){d.remove()})}),Leela.map.el.append(d)}if(1==a||n||-1!==$.inArray(Leela.map.cells[s-1].type,["birth","arrow","snake"])){var c=$("#cell-"+a),m=c.position();$("#map-player-"+LeelaGame.turn).animate({top:m.top,left:m.left},"slow",function(){l()})}else for(var o=s+1;a>=o;o++){var c=$("#cell-"+o),m=c.position(),p=s+1;$("#map-player-"+LeelaGame.turn).animate({top:m.top,left:m.left},"slow",function(){a>p?p++:l()})}}},history:{init:function(){Leela.history.root=$("#actions-history"),Leela.history.el.on("click",".hist-cell",function(){$("#cell-"+$(this).attr("data-id")).click()}),$(document).on("click",".hist-step-full a",function(){$("#cell-"+$(this).attr("data-id")).click()}),$("#hist-new").click(function(){window.confirm($("#alert-hist-new").text())&&(localStorage.removeItem("LeelaGame"),window.location.reload(!0))})},add:function(e,a,l){var i=LeelaGame.players[Leela.players.get(e.player_id).i],t=i.history,n=new Date(e.date),r=("0"+n.getDate()).slice(-2)+"."+("0"+(n.getMonth()+1)).slice(-2)+" "+("0"+n.getHours()).slice(-2)+":"+("0"+n.getMinutes()).slice(-2),o=[{name:"id",value:i.id},{name:"name",value:i.name},{name:"date",value:r},{name:"cell_id",value:e.cell_id},{name:"cell_name",value:Leela.map.cells[e.cell_id-1].name}];a||t.push(e),l?$(".remodal .hist-steps-full").prepend(Leela.design.tpl(".hist-step-full:first",o)):(Leela.history.root.is(":hidden")&&Leela.history.root.show(),Leela.history.el.prepend(Leela.design.tpl(".hist-step:first",o)))},fill:function(e){var a=[];if(e){var l=LeelaGame.players[Leela.players.get(e).i];Leela.players.add(l,1,e),a=a.concat(l.history)}else for(var i=LeelaGame.players.length,t=0;i>t;t++)Leela.players.add(LeelaGame.players[t],1,e),a=a.concat(LeelaGame.players[t].history);a.sort(Leela.history.sort),e&&(a.reverse(),$("#history-full").html(""));for(var n=0,i=a.length,t=0;i>t;t++)a[t].dice&&(n=a[t].dice),Leela.history.add(a[t],1,e);!e&&n&&Leela.actions.dice.el.attr("class","dice-"+n).attr("data-value")},sort:function(e,a){return e.date<a.date?-1:e.date>a.date?1:0}},actions:{init:function(){Leela.actions.btn=$("#actions-btn"),Leela.actions.panel=$("#actions-panel"),Leela.actions.help=$("#actions-help"),Leela.actions.dice.root=$("#actions-dices"),Leela.actions.dice.el=$("#actions-dice"),Leela.actions.birth=$("#actions-birth"),Leela.actions.arrow=$("#actions-arrow"),Leela.actions.snake=$("#actions-snake"),Leela.actions.dice.root.on("click",".dice-aside button",function(){Leela.actions.dice.roll($(this).attr("data-value"))}),Leela.actions.dice.el.click(function(){Leela.actions.dice.roll()}),Leela.actions.birth.click(function(){Leela.players.move(0,6)}),Leela.actions.arrow.add(Leela.actions.snake).click(function(){var e=LeelaGame.players[Leela.players.get(LeelaGame.turn).i].history,a=e[e.length-1].cell_id,l=Leela.map.cells[a-1]["goto"];Leela.players.move(0,l)})},nav:function(){var e=LeelaGame.players[Leela.players.get(LeelaGame.turn).i],a=e.history,l=a.length?a[a.length-1].cell_id:68,i=Leela.map.cells[l-1].type,t=-1!==$.inArray(i,["birth","arrow","snake"]),n=[{name:"id",value:e.id},{name:"name",value:e.name}];t?(Leela.actions.dice.root.prop("disabled",!0).fadeOut("slow"),"birth"==i&&(Leela.actions.birth.show(),Leela.actions.help.html(Leela.design.tpl(".help-birth:first",n))),"arrow"==i&&(Leela.actions.arrow.show(),Leela.actions.help.html(Leela.design.tpl(".help-arrow:first",n))),"snake"==i&&(Leela.actions.snake.show(),Leela.actions.help.html(Leela.design.tpl(".help-snake:first",n)))):(Leela.actions.birth.add(Leela.actions.arrow).add(Leela.actions.snake).prop("disabled",!0).fadeOut("slow"),Leela.actions.dice.root.fadeIn("slow"),a.length&&68==a[a.length-1].cell_id?Leela.actions.help.html(Leela.design.tpl(".help-win:first",n)):a.length&&68!=a[a.length-1].cell_id?e.six&&e.six<3?Leela.actions.help.html(Leela.design.tpl(".help-six:first",n)):e.six>=3?Leela.actions.help.html(Leela.design.tpl(".help-six-again:first",n)):Leela.actions.help.html(Leela.design.tpl(".help-dice:first",n)):Leela.actions.help.html(Leela.design.tpl(".help-start:first",n))),Leela.actions.panel.find("button").prop("disabled",!1),localStorage.setItem("LeelaGame",JSON.stringify(LeelaGame))},dice:{cheat:0,rand:function(){return Math.floor(6*Math.random())+1},roll:function(e){if(!Leela.actions.dice.cheat&&e){if(!window.confirm($("#alert-cheat-confirm").text()))return;Leela.actions.dice.cheat=1}Leela.actions.panel.find("button").prop("disabled",!0);for(var a=Leela.actions.dice.rand(),l=300,i=1,t=1,n=0;a>n;n++)Leela.actions.dice.el.animate({opacity:0},l,function(){var l=e&&i==a?e:Leela.actions.dice.rand();Leela.actions.dice.el.attr("class","dice-"+l).attr("data-value",l),i++}).animate({opacity:1},l,function(){t==a&&Leela.players.move(Leela.actions.dice.el.attr("data-value")),t++})}}},map:{image:"img/map.jpg",width:765,height:700,init:function(){Leela.map.el.on("click",".cell",function(){var e=$(this),a=e.attr("data-id");$.get("data/"+a+".html",function(e){var l=[{name:"id",value:"cell-"+a},{name:"data",value:e}];Leela.design.modal&&Leela.design.modal.destroy(),Leela.design.modal=$(Leela.design.tpl(".remodal-tpl:first",l)),Leela.design.modal.removeClass("remodal-tpl").addClass("remodal").appendTo("body"),Leela.design.modal=Leela.design.modal.remodal(),Leela.design.modal.open()})})},grid:[72,71,70,69,68,67,66,65,64,55,56,57,58,59,60,61,62,63,54,53,52,51,50,49,48,47,46,37,38,39,40,41,42,43,44,45,36,35,34,33,32,31,30,29,28,19,20,21,22,23,24,25,26,27,18,17,16,15,14,13,12,11,10,1,2,3,4,5,6,7,8,9],cells:[{id:1,name:"Рождение",type:"birth","goto":6},{id:2,name:"Майа"},{id:3,name:"Гнев"},{id:4,name:"Жадность"},{id:5,name:"Физический план"},{id:6,name:"Заблуждение"},{id:7,name:"Тщеславие"},{id:8,name:"Алчность"},{id:9,name:"Чувственный план"},{id:10,name:"Очищение",type:"arrow","goto":23},{id:11,name:"Развлечения"},{id:12,name:"Зависть",type:"snake","goto":8},{id:13,name:"Ничтожность"},{id:14,name:"Астральный план"},{id:15,name:"План фантазии"},{id:16,name:"Ревность",type:"snake","goto":4},{id:17,name:"Сострадание",type:"arrow","goto":69},{id:18,name:"План радости"},{id:19,name:"План кармы"},{id:20,name:"Благотворительность",type:"arrow","goto":32},{id:21,name:"Искупление"},{id:22,name:"План Дхармы",type:"arrow","goto":60},{id:23,name:"Небесный план"},{id:24,name:"Плохая компания",type:"snake","goto":7},{id:25,name:"Хорошая компания"},{id:26,name:"Печаль"},{id:27,name:"Самоотверженное служение",type:"arrow","goto":41},{id:28,name:"Истинная религиозность",type:"arrow","goto":50},{id:29,name:"Неправедность",type:"snake","goto":6},{id:30,name:"Хорошие тенденции"},{id:31,name:"План святости"},{id:32,name:"План равновесия"},{id:33,name:"План ароматов"},{id:34,name:"План вкуса"},{id:35,name:"Чистилище"},{id:36,name:"Ясность сознания"},{id:37,name:"Джняна",type:"arrow","goto":66},{id:38,name:"Прана-лока"},{id:39,name:"Апана-лока"},{id:40,name:"Въяна-лока"},{id:41,name:"Человеческий план"},{id:42,name:"План Агни"},{id:43,name:"Рождение человека"},{id:44,name:"Неведение",type:"snake","goto":9},{id:45,name:"Правильное знание",type:"arrow","goto":67},{id:46,name:"Различение",type:"arrow","goto":62},{id:47,name:"План нейтральности"},{id:48,name:"Солнечный план"},{id:49,name:"Лунный план"},{id:50,name:"План аскетизма"},{id:51,name:"Земля"},{id:52,name:"План насилия",type:"snake","goto":35},{id:53,name:"План жидкостей"},{id:54,name:"План духовной преданности",type:"arrow","goto":68},{id:55,name:"Эгоизм",type:"snake","goto":3},{id:56,name:"План изначальных вибраций"},{id:57,name:"План газов"},{id:58,name:"План сияния"},{id:59,name:"План реальности"},{id:60,name:"Позитивный интеллект"},{id:61,name:"Негативный интеллект",type:"snake","goto":13},{id:62,name:"Счастье"},{id:63,name:"Тамас",type:"snake","goto":2},{id:64,name:"Феноменальный план"},{id:65,name:"План внутреннего пространства"},{id:66,name:"План блаженства"},{id:67,name:"План космического блага"},{id:68,name:"Космическое Сознание"},{id:69,name:"План Абсолюта"},{id:70,name:"Саттвагуна"},{id:71,name:"Раджогуна"},{id:72,name:"Тамогуна",type:"snake","goto":51}]}},Leela.init(),navigator.notification&&(alert=function(e,a){navigator.notification.alert(e,null,a||"","OK")});